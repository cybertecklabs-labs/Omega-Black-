import { useParams } from 'react-router-dom';
import { useGetVulnerabilityQuery, useCloneVulnerabilityMutation } from '../redux/services/apiSlice';
import { useState } from 'react';
import Button from '../components/ui/Button';
import Modal from '../components/ui/Modal';

export default function VulnerabilityDetail() {
    const { id } = useParams();
    const { data: vuln, isLoading } = useGetVulnerabilityQuery(id);
    const [cloneVulnerability] = useCloneVulnerabilityMutation();
    const [showCloneModal, setShowCloneModal] = useState(false);

    if (isLoading) return <div>Loading...</div>;
    if (!vuln) return <div>Not found</div>;

    const handleClone = async () => {
        await cloneVulnerability(id);
        setShowCloneModal(false);
    };

    return (
        <div className="max-w-4xl mx-auto space-y-6">
            <h1 className="text-2xl font-bold">{vuln.title}</h1>
            <div className="bg-white dark:bg-gray-800 shadow rounded-lg p-6 space-y-4">
                <div className="flex justify-between">
                    <span className={`px-3 py-1 rounded-full text-sm font-medium ${vuln.severity === 'critical' ? 'bg-red-100 text-red-800' :
                            vuln.severity === 'high' ? 'bg-orange-100 text-orange-800' :
                                'bg-yellow-100 text-yellow-800'
                        }`}>
                        {vuln.severity}
                    </span>
                    <span className="text-gray-500">CVSS: {vuln.cvss || 'N/A'}</span>
                </div>
                <p className="text-gray-700 dark:text-gray-300">{vuln.description}</p>
                {vuln.aiAnalysis && (
                    <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded border border-blue-200">
                        <h3 className="font-medium mb-2">ðŸ¤– AI Analysis</h3>
                        <p className="text-sm">Confidence: {(vuln.aiAnalysis.confidence * 100).toFixed(0)}%</p>
                        <p className="text-sm mt-1">{vuln.aiAnalysis.explanation}</p>
                    </div>
                )}
                <Button onClick={() => setShowCloneModal(true)} variant="secondary">
                    Clone Vulnerability
                </Button>
            </div>
            <Modal isOpen={showCloneModal} onClose={() => setShowCloneModal(false)}>
                <h3 className="text-lg font-medium">Clone Vulnerability</h3>
                <p className="mt-2">Create a copy of this vulnerability?</p>
                <div className="mt-4 flex justify-end space-x-3">
                    <Button variant="outline" onClick={() => setShowCloneModal(false)}>Cancel</Button>
                    <Button onClick={handleClone}>Clone</Button>
                </div>
            </Modal>
        </div>
    );
}
