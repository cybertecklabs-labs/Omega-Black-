version: "3.9"

services:
  cortex-gateway:
    image: ghcr.io/cybertecklabs/omega-black-cortex-gateway:bridge
    container_name: omega-cortex-gateway
    restart: unless-stopped
    env_file:
      - .env.bridge
    environment:
      - PORT=8080
      - PUBLIC_API_BASE_URL=${PUBLIC_API_BASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ISSUER=${JWT_ISSUER}
      - JWT_AUDIENCE=${JWT_AUDIENCE}
      - TEMPORAL_ADDRESS=temporal-bridge-worker:7233
      - MEMORY_BANK_GRPC_URL=pgvector-sync:50051
      - TUNNEL_PUBLIC_HOST=${TUNNEL_PUBLIC_HOST}
    ports:
      - "8080:8080"
    depends_on:
      - temporal-bridge-worker
      - pgvector-sync
    networks:
      - sovereign-bridge

  temporal-bridge-worker:
    image: ghcr.io/cybertecklabs/omega-temporal-bridge-worker:bridge
    container_name: omega-temporal-bridge-worker
    restart: unless-stopped
    env_file:
      - .env.bridge
    environment:
      - TEMPORAL_NAMESPACE=${TEMPORAL_NAMESPACE}
      - TEMPORAL_TASK_QUEUE=${TEMPORAL_TASK_QUEUE}
      - LAB_TEMPORAL_HOST=${LAB_TEMPORAL_HOST}
      - LAB_TEMPORAL_PORT=${LAB_TEMPORAL_PORT}
    volumes:
      - ./secrets/lab-temporal:/secrets/lab-temporal:ro
    networks:
      - sovereign-bridge

  pgvector-sync:
    image: ghcr.io/cybertecklabs/omega-black-pgvector-sync:bridge
    container_name: omega-pgvector-sync
    restart: unless-stopped
    env_file:
      - .env.bridge
    environment:
      - PUBLIC_PGVECTOR_URL=${PUBLIC_PGVECTOR_URL}
      - PUBLIC_PGVECTOR_DB=${PUBLIC_PGVECTOR_DB}
      - PUBLIC_PGVECTOR_USER=${PUBLIC_PGVECTOR_USER}
      - PUBLIC_PGVECTOR_PASSWORD=${PUBLIC_PGVECTOR_PASSWORD}
      - LAB_PGVECTOR_URL=${LAB_PGVECTOR_URL}
      - LAB_PGVECTOR_DB=${LAB_PGVECTOR_DB}
      - LAB_PGVECTOR_USER=${LAB_PGVECTOR_USER}
      - LAB_PGVECTOR_PASSWORD=${LAB_PGVECTOR_PASSWORD}
      - SYNC_SCHEDULE=${SYNC_SCHEDULE:-0 */1 * * *}
      - SYNC_DIRECTION=${SYNC_DIRECTION:-lab-to-public}
    networks:
      - sovereign-bridge

  prometheus:
    image: prom/prometheus:latest
    container_name: omega-bridge-monitor
    restart: unless-stopped
    volumes:
      - ./ops/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    networks:
      - sovereign-bridge

  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: omega-bridge-tunnel
    restart: unless-stopped
    env_file:
      - .env.bridge
    command: tunnel run --protocol http2 ${TUNNEL_NAME}
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    depends_on:
      - cortex-gateway
    networks:
      - sovereign-bridge

networks:
  sovereign-bridge:
    driver: bridge
