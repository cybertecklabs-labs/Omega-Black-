const Vulnerability = require('../models/Vulnerability');
const aiService = require('../services/aiService');

exports.createVulnerability = async (req, res, next) => {
    try {
        const { title, description, targetId, useAI } = req.body;
        let aiAnalysis = null;
        if (useAI) aiAnalysis = await aiService.analyzeWithGemini(description);
        const vulnerability = await Vulnerability.create({
            title, description,
            target: targetId,
            reporter: req.user.id,
            aiAnalysis
        });
        res.status(201).json({ success: true, data: vulnerability });
    } catch (error) { next(error); }
};

exports.cloneVulnerability = async (req, res, next) => {
    try {
        const original = await Vulnerability.findById(req.params.id);
        if (!original) return res.status(404).json({ success: false, error: 'Not found' });
        const clone = await Vulnerability.create({
            ...original.toObject(),
            _id: undefined,
            title: `[CLONE] ${original.title}`,
            reporter: req.user.id,
            status: 'new',
            clonedFrom: original._id,
            createdAt: Date.now()
        });
        res.status(201).json({ success: true, data: clone });
    } catch (error) { next(error); }
};

exports.getVulnerabilities = async (req, res, next) => {
    try {
        const vulns = await Vulnerability.find()
            .populate('target', 'name domain')
            .populate('reporter', 'username')
            .sort('-createdAt');
        res.json({ success: true, data: vulns });
    } catch (error) { next(error); }
};

exports.getVulnerability = async (req, res, next) => {
    try {
        const vuln = await Vulnerability.findById(req.params.id)
            .populate('target')
            .populate('reporter', 'username')
            .populate('assignedTo', 'username')
            .populate('clonedFrom', 'title');
        if (!vuln) return res.status(404).json({ success: false, error: 'Not found' });
        res.json({ success: true, data: vuln });
    } catch (error) { next(error); }
};

exports.updateVulnerability = async (req, res, next) => {
    try {
        const vuln = await Vulnerability.findByIdAndUpdate(req.params.id, req.body, { new: true });
        if (!vuln) return res.status(404).json({ success: false, error: 'Not found' });
        res.json({ success: true, data: vuln });
    } catch (error) { next(error); }
};

exports.deleteVulnerability = async (req, res, next) => {
    try {
        const vuln = await Vulnerability.findByIdAndDelete(req.params.id);
        if (!vuln) return res.status(404).json({ success: false, error: 'Not found' });
        res.json({ success: true, data: {} });
    } catch (error) { next(error); }
};
